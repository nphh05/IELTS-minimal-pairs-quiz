<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Minimal Pair Quiz</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: 24px auto; }
    .question { margin-bottom: 16px; padding: 14px; border: 1px solid #ddd; border-radius: 10px; }
    .choices label { display: block; margin: 6px 0; padding: 6px 8px; border-radius: 6px; border: 1px solid transparent;}
    .correct { background: #e8f7e8; border-color: #6ccf6c; }
    .incorrect { background: #fde8e8; border-color: #f38b8b; }
    .answer-key { font-size: 0.9em; opacity: 0.9; }
    .muted { opacity: 0.6; }
    .controls { display: flex; gap: 10px; margin-top: 10px; }
    .msg { margin-top: 12px; min-height: 20px; }
  </style>
</head>
<body>
  <h1>Minimal Pairs Listening Test</h1>

  <form id="quizForm"></form>

  <div class="controls">
    <button type="button" id="submitBtn">Submit</button>
    <button type="button" id="resetBtn">Reset</button>
  </div>

  <p id="result" class="msg"></p>
  <p id="sync" class="msg"></p>
  <form id="hiddenForm" action="https://script.google.com/macros/s/AKfycbxlNTe3oitwcqsZSlPIQhPof2-XVhuZQlW9dRVLtgQdrL3H8oMQdhUOtGM2Lg0gW1cp/exec" method="POST" target="hiddenFrame">
  <input type="hidden" name="payload" id="formPayload">
  </form>
  <iframe name="hiddenFrame" style="display:none;"></iframe>

  <script>
    /* =============================
       CẤU HÌNH CÂU HỎI Ở ĐÂY
       ============================= */
    const QUESTIONS = [
      {
        id: "q1",
      	audio: "bin.mp3",
        type: "single",
      	options: ["bin /bɪn/", "bean /biːn/"],
      	correct: "bin /bɪn/"
      },
      {
        id: "q2",
        type: "multi-audio-dropdown",
        question: "Listen to each audio and choose the correct word",
        items: [
          {
            audio: "fell.mp3",
            options: ["fill", "fell"],
            correct: "fell"
          },
          {
            audio: "fill.mp3",
            options: ["fill", "fell"],
            correct: "fill"
          }
        ]
      }
    ];

    // Link Google Apps Script (để lưu kết quả)
    const GOOGLE_APPS_SCRIPT_ENDPOINT = "https://script.google.com/macros/s/AKfycbxlNTe3oitwcqsZSlPIQhPof2-XVhuZQlW9dRVLtgQdrL3H8oMQdhUOtGM2Lg0gW1cp/exec";

    /* =============================
       HÀM TẠO FORM TỪ CÂU HỎI
       ============================= */
    function renderQuestions() {
      const form = document.getElementById('quizForm');
      form.innerHTML = "";
      QUESTIONS.forEach((q, idx) => {
        const div = document.createElement('div');
        div.className = 'question';
        div.dataset.qid = q.id;
    
        // Loại 1: Câu hỏi chọn 1 đáp án từ 1 audio (radio)
        if (!q.type || q.type === "single") {
          div.dataset.correct = q.correct;
          div.innerHTML = `
            <p><b>Q${idx + 1}.</b> Which word did you hear?</p>
            <audio controls preload="auto">
              <source src="${q.audio}" type="audio/mpeg">
            </audio>
            <div class="choices">
              ${q.options.map(opt => `
                <label>
                  <input type="radio" name="${q.id}" value="${opt}"> ${opt}
                </label>
              `).join('')}
            </div>
            <div class="answer-key muted"></div>
          `;
        }
    
        // Loại 2: Nhiều audio, mỗi audio có dropdown chọn đáp án
        else if (q.type === "multi-audio-dropdown") {
          div.innerHTML = `
            <p><b>Q${idx + 1}.</b> ${q.question}</p>
            ${q.items.map((item, subIdx) => {
              const subId = `${q.id}_item${subIdx}`;
              return `
                <div class="sub-question" data-correct="${item.correct}" data-subid="${subId}">
                  <audio controls preload="auto">
                    <source src="${item.audio}" type="audio/mpeg">
                  </audio>
                  <select name="${subId}">
                    <option value="">-- Choose --</option>
                    ${item.options.map(opt => `
                      <option value="${opt}">${opt}</option>
                    `).join('')}
                  </select>
                  <div class="answer-key muted"></div>
                </div>
              `;
            }).join('')}
          `;
        }
    
        form.appendChild(div);
      });
    }


    /* =============================
       HÀM RESET HIGHLIGHT
       ============================= */
    function clearHighlights() {
      document.querySelectorAll('.choices label').forEach(lb => {
        lb.classList.remove('correct', 'incorrect');
      });
      document.querySelectorAll('.answer-key').forEach(el => el.textContent = '');
      document.getElementById('result').textContent = '';
      document.getElementById('sync').textContent = '';
    }

    /* =============================
       HÀM CHẤM ĐIỂM
       ============================= */
    function checkAnswers() {
  const allQuestions = document.querySelectorAll('.question');
  let correctCount = 0;
  let total = 0;

  const answersToSave = [];

  allQuestions.forEach(q => {
    const qType = q.dataset.qtype || 'single';

    // Loại 1: radio
    if (qType === "single") {
      const selected = q.querySelector('input[type="radio"]:checked');
      const answerKey = q.querySelector('.answer-key');
      total++;

      if (!selected) {
        answerKey.textContent = "No choice";
        answerKey.classList.remove('correct', 'wrong');
        answerKey.classList.add('muted');
      } else if (selected.value === q.dataset.correct) {
        answerKey.textContent = "Correct";
        answerKey.classList.remove('wrong', 'muted');
        answerKey.classList.add('correct');
        correctCount++;
      } else {
        answerKey.textContent = `Wrong | Answer: ${q.dataset.correct}`;
        answerKey.classList.remove('correct', 'muted');
        answerKey.classList.add('wrong');
      }

      answersToSave.push({
        id: q.dataset.qid,
        answer: selected ? selected.value : null
      });
    }

    // Loại 2: multi-audio-dropdown
    else if (qType === "multi-audio-dropdown") {
      const subQuestions = q.querySelectorAll('.sub-question');
      subQuestions.forEach(sub => {
        const correct = sub.dataset.correct;
        const select = sub.querySelector('select');
        const chosen = select.value;
        const answerKey = sub.querySelector('.answer-key');
        total++;

        if (chosen === correct) {
          answerKey.textContent = "Correct";
          answerKey.classList.remove('wrong', 'muted');
          answerKey.classList.add('correct');
          correctCount++;
        } else {
          answerKey.textContent = `Wrong | Answer: ${correct}`;
          answerKey.classList.remove('correct', 'muted');
          answerKey.classList.add('wrong');
        }

        answersToSave.push({
          id: sub.dataset.subid,
          answer: chosen || null
        });
      });
    }
  });

  const scorePercent = Math.round((correctCount / total) * 100);
  document.getElementById('scoreBox').textContent = `Score: ${correctCount}/${total} (${scorePercent}%)`;

  // Lưu lại nếu cần
  // saveResult(scorePercent, answersToSave);
}
    /* =============================
       HÀM GỬI KẾT QUẢ LÊN GOOGLE SHEETS
       ============================= */
    function sendToSheet(payload) {
      document.getElementById('sync').textContent = "Sending results...";
      const form = document.getElementById('hiddenForm');
      document.getElementById('formPayload').value = JSON.stringify(payload);
      form.submit();
      // Since form submissions don't provide a direct response, assume success after a delay
      setTimeout(() => {
        document.getElementById('sync').textContent = "Results sent to Google Sheets (check the sheet to confirm).";
      }, 1000);
    }

    /* =============================
       SỰ KIỆN NÚT BẤM
       ============================= */
    document.getElementById('submitBtn').addEventListener('click', async () => {
      const result = checkAnswers();
      const attempt = {
        quizId: "minimal_pairs_v1",
        timestamp: new Date().toISOString(),
        learnerId: (new URLSearchParams(location.search).get('user')) || "anonymous",
        score: result.correct,
        total: result.total,
        details: result.details
      };
      await sendToSheet(attempt);
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      document.getElementById('quizForm').reset();
      clearHighlights();
    });

    /* =============================
       CHẠY LẦN ĐẦU
       ============================= */
    renderQuestions();
    clearHighlights();
  </script>
</body>

</html>










